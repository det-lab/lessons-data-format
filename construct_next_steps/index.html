
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../kaitai_next_steps/">
      
      
        <link rel="next" href="../conclusion/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.2.7">
    
    
      
        <title>8. Construct Next Steps - Custom data format</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#objectives" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Custom data format" class="md-header__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Custom data format
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              8. Construct Next Steps
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Custom data format" class="md-nav__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Custom data format
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Setup
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../filetype/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. File types
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kaitai_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Kaitai basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../construct_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Construct basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../creating_example_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Creating Example Data
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kaitai_next_steps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Kaitai Next Steps
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    8. Construct Next Steps
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    8. Construct Next Steps
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-describing-the-data-in-construct" class="md-nav__link">
    8: Describing the data in Construct
  </a>
  
    <nav class="md-nav" aria-label="8: Describing the data in Construct">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-parsing-raw-data-using-construct" class="md-nav__link">
    8.1: Parsing raw data using Construct
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. Conclusion
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-describing-the-data-in-construct" class="md-nav__link">
    8: Describing the data in Construct
  </a>
  
    <nav class="md-nav" aria-label="8: Describing the data in Construct">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-parsing-raw-data-using-construct" class="md-nav__link">
    8.1: Parsing raw data using Construct
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h3 id="objectives">Objectives:</h3>
<ul>
<li>Create Structs to describe our fabricated data using the Construct library.</li>
<li>Combine our Structs in a final description of our custom file format.</li>
<li>Parse our custom file format using our Struct.</li>
</ul>
<h1 id="8-describing-the-data-in-construct">8: Describing the data in Construct</h1>
<p>If for some reason it might benefit your project to create a description of your file format using both Kaitai and Construct, I'd recommend first creating a Kaitai description and then basing your Construct file off of it, simply because the syntax for Kaitai is a little more straightforward. As before, there is an example file for this section on <a href="https://github.com/det-lab/lessons-data-format/blob/gh-pages/examples/example_struct.ipynb">this page's github</a>. With that being said, let's open up a new <code>.py</code> or <code>.ipynb</code> file and begin by importing the Construct module, matplotlib.pyplot, and numpy before defining our Structs. </p>
<pre><code>from construct import *
import matplotlib.pyplot as plt
import numpy as np
</code></pre>
<p>Next, as before, we'll want to capture the three numbers at the front of the file which tell us how long each array is. Our approach here will look much like our work in Kaitai, but there are still multiple different ways to perform this capture, and experimenting to see what feels most efficient for you is encouraged.</p>
<p>For this example, I'm going to start off with what will eventually be the final Struct and create a sub Struct which will capture those values.</p>
<pre><code>test_struct = Struct(
  &quot;lengths&quot; / Struct(
    &quot;full_data_len&quot; / Int32ul,
    &quot;mid_data_len&quot; / Int32ul,
    &quot;peak_data_len&quot; / Int32ul
  )
)
</code></pre>
<p>This could be accomplished equivalently by creating the lengths <code>Struct</code> first, followed by using it in <code>test_struct</code>.</p>
<p>As mentioned previously, <code>test_struct</code> will be used at the final step of the description. This is a limitation of Python, as Python is unable to use variables or Structs that have yet to be declared. But, since the <code>Struct</code> that comes before this one will only be <strong>used</strong> when it's nested into <code>test_struct</code>, we'll be able to reference the <code>lengths</code> sub-Struct to capture the full, mid, and peak data lengths. Each of the data sections will select 4 bytes at a time and save them into an array of the given length.</p>
<pre><code>data_sections = Struct(
    &quot;full_x_data&quot; / Array(
        this._root.lengths.full_data_len,
        Float32l
    ),
    &quot;full_y_data&quot; / Array(
        this._root.lengths.full_data_len,
        Float32l
    ),

    &quot;mid_x_data&quot; / Array(
        this._root.lengths.mid_data_len,
        Float32l
    ),
    &quot;mid_y_data&quot; / Array(
        this._root.lengths.mid_data_len,
        Float32l
    ),

    &quot;peak_x_data&quot; / Array(
        this._root.lengths.peak_data_len,
        Float32l
    ),
    &quot;peak_y_data&quot; / Array(
        this._root.lengths.peak_data_len,
        Float32l
    ),
)
</code></pre>
<p>Again, there are plenty of ways to do this. You could instead make a different <code>Struct</code> for each of the data captures and then put them altogether in <code>data_sects</code>. Or you could copy what we did with the <code>lengths</code> <code>Struct</code>, using only <code>test_struct</code> to define your data with everything else as a substruct. As it is though, we can add this Struct into <code>test_struct</code> as:</p>
<pre><code>test_struct = Struct(
    &quot;lengths&quot; / Struct(
        &quot;full_data_len&quot; / Int32ul,
        &quot;mid_data_len&quot; / Int32ul,
        &quot;peak_data_len&quot; / Int32ul
    ),
    &quot;data_sects&quot; / data_sections
)
</code></pre>
<p>For selections that only have one defining <code>Struct</code>, like <code>data_sects</code>, there isn't necessarily a reason not to also name the sub <code>Struct</code> (<code>data_sects</code>) after the <code>Struct</code> that it's using (<code>data_sections</code>). In this case, it's simply a matter of shortening the name to reduce how much typing is necessary to call that attribute later. It's not uncommon to have a <code>Struct</code> with a very clear name which is then given a shortened name in the higher <code>Struct</code> which actually uses it. Remember when doing this that only the quoted name will be useable. If You try to reference <code>data_sections</code> instead of <code>data_sects</code>, you'll end up with a <code>KeyError</code>.</p>
<h2 id="81-parsing-raw-data-using-construct">8.1: Parsing raw data using Construct</h2>
<p>This process is much simpler than with Kaitai - you can do all of the work from the same file as where you set the Structs. </p>
<p>Let's now create a function that parses our file and plots the results:</p>
<pre><code>def parse_file(input_path):
  with open(input_path, 'rb') as input_f: # 'rb' ='read binary'
    raw_data = input_f.read()
    parsed_data = test_struct.parse(raw_data)

    # Select all relevant values
    full_x_data = parsed_data.data_sects.full_x_data
    full_y_data = parsed_data.data_sects.full_y_data

    mid_x_data = parsed_data.data_sects.mid_x_data
    mid_y_data = parsed_data.data_sects.mid_y_data

    peak_x_data = parsed_data.data_sects.peak_x_data
    peak_y_data = parsed_data.data_sects.peak_y_data

    # Plot all data
    plt.plot(full_x_data, full_y_data)
    plt.plot()
    plt.show()

    plt.scatter(mid_x_data, mid_y_data, s=1)
    plt.plot()
    plt.show()

    plt.scatter(peak_x_data, peak_y_data, s=1)
    plt.plot()
    plt.show()
</code></pre>
<p>Now all that's left is to call our <code>parse_file</code> function:</p>
<pre><code>input_path = &lt;/your/path/to/wave_data.test&gt;
parse_file(input_path)
</code></pre>
<p>And you have officially parsed your first file using Construct!</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>
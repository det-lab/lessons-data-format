
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../kaitai_basics/">
      
      
        <link rel="next" href="../putting_it_together/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.2.7">
    
    
      
        <title>5. Construct basics - Custom data format</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5-defining-the-structure-in-construct" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Custom data format" class="md-header__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Custom data format
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              5. Construct basics
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Custom data format" class="md-nav__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Custom data format
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Setup
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../filetype/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. File types
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kaitai_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Kaitai basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    5. Construct basics
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    5. Construct basics
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-struct-basics" class="md-nav__link">
    5.1 Struct basics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-building-gifpy" class="md-nav__link">
    5.2 Building gif.py
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../putting_it_together/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Putting it together
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Conclusion
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Advanced
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-struct-basics" class="md-nav__link">
    5.1 Struct basics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-building-gifpy" class="md-nav__link">
    5.2 Building gif.py
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="5-defining-the-structure-in-construct">5: Defining the Structure in Construct</h1>
<p>As mentioned earlier, Construct is a library designed to work specifically in Python, but it's functionality is similar to the functionality of Kaitai, just with more programmatic language. In Construct, we define <code>Structs</code> which are similar to <code>types</code> in Kaitai. After describing the structure of a section on the byte level, <code>Structs</code> can then be combined with each other to capture larger sections of the data until they're combined in a final <code>Struct</code> which captures all of the file's data.</p>
<h2 id="51-struct-basics">5.1 Struct basics</h2>
<p>In Construct, a <code>Struct</code> is a collection of ordered and (usually) named fields that are then parsed or built in the defined order. The <code>Struct</code> can either used to parse a file's data or build a file that matches the file format. When a <code>Struct</code> is parsed, values are returned in a dictionary with keys matching the defined names, but names aren't strictly necessary like they are in Kaitai. It's possible to instead build from nothing and return nothing when parsing, so a name can be skipped in those instances. </p>
<p>Let's recreate our dimension example from the Kaitai section. We can define the <code>dimensions</code> <code>Struct</code> with:</p>
<pre><code>dimensions = Struct(
    &quot;width&quot; / Int16ul,
    &quot;height&quot; / Int16ul
)
</code></pre>
<p><code>Int16ul</code> here means that we are deciphering the width and height as an <strong>Int</strong>eger of <strong>16</strong> <strong>u</strong>nsigned bits in <strong>l</strong>ittle endian format. To show how that type could then be used elsewhere, we could define another <code>Struct</code> using it:</p>
<pre><code>example = Struct(
  &quot;dimensions&quot; / dimensions
)
</code></pre>
<h2 id="52-building-gifpy">5.2 Building gif.py</h2>
<p>Ok, now let's take a look at how Construct defines a gif from the file <a href="https://github.com/construct/construct/blob/master/deprecated_gallery/gif.py">gif.py</a> in Construct's github. </p>
<p>When we look at <code>gif.py</code>, we can see that the structure is essentially reversed when compared to Kaitai. All of the smaller, defining fields come first before they're put together into larger <code>Structs</code>. This is because the structures in Kaitai are global; the order is arbitrary as long as they're placed in the right sections (<code>types</code> or <code>seq</code>), while in Construct the structures must be defined in order - one <code>Struct</code> can't use another unless the other is already defined. Let's try looking at the file backwards then, starting with the final <code>Struct</code> on line 121:</p>
<pre><code>gif_file = Struct(
    &quot;signature&quot; / Const(b&quot;GIF&quot;),
    &quot;version&quot; / Const(b&quot;89a&quot;),
    &quot;logical_screen&quot; / gif_logical_screen,
    &quot;data&quot; / GreedyRange(gif_data),
    # Const(Int8ul(&quot;trailer&quot;), 0x3B)
)
</code></pre>
<p>In the <code>gif_file</code> <code>Struct</code>, we can see that instead of there being a defined <code>header</code> <code>Struct</code>, we can instead just grab the <code>signature</code> and <code>version</code> as <code>Const</code> (constant) types, which functions much like the <code>magic</code> keyword in Kaitai. The only downside to doing it this way as opposed to setting a <code>Struct</code> earlier is that it will fail to parse if the version is different than the defined <code>89a</code>, instead returning an error. After those, we see: <code>"logical_screen" / gif_logical_screen</code>, <code>"data" / GreedyRange(gif_data)</code>, and an optional (commented out) <code>Const(Int8ul("trailer"), 0x3B)</code>. </p>
<p>Let's take a look at the <code>logical_screen</code> <code>Struct</code> which can be found at line 20 to see how it's defined in Construct:</p>
<pre><code>gif_logical_screen = Struct(
    &quot;width&quot; / Int16ul,
    &quot;height&quot; / Int16ul,
    &quot;flags&quot; / BitStruct(
        &quot;global_color_table&quot; / Bit,
        &quot;color_resolution&quot; / BitsInteger(3),
        &quot;sort_flag&quot; / Bit,
        &quot;global_color_table_bpp&quot; / BitsInteger(3),
    ),
    &quot;bgcolor_index&quot; / Int8ul,
    &quot;pixel_aspect_ratio&quot; / Int8ul,
    &quot;palette&quot; / If(this.flags.global_color_table,
        Array(lambda this: 2**(this.flags.global_color_table_bpp + 1),
            Struct(
                &quot;R&quot; / Int8ul,
                &quot;G&quot; / Int8ul,
                &quot;B&quot; / Int8ul,
            ))),
)
</code></pre>
<p>Here we can see that <code>width</code> and <code>height</code> have the expected definitions, only selecting 2 bytes each, but <code>flags</code> is using something called a <code>BitStruct</code>. These are much like a normal <code>Struct</code>, but designed to operate on bits instead of bytes. In parsing these, the data is converted to a stream of <code>\x01</code> and <code>\x00</code>s (<code>1</code>s and <code>0</code>s) and then fed into the substructs. So <code>global_color_table</code> grabs just the first bit, <code>color_resolution</code> grabs the next 3 bits and parses them as an integer, etc. These values are then used in <code>palette</code> if <code>global_color_table</code> is <code>True</code> (<code>1</code>), and an <code>Array</code> is constructed with a length determined by raising 2 to the power of <code>global_color_table_bpp + 1</code> where each element in the array is another <code>Struct</code> defining the RGB values of each pixel.</p>
<p>When we take a look at the next section, <code>"data" / GreedyRange(gif_data)</code>, we can see a bit more of how Construct utilizes its nested <code>Struct</code>. The <code>gif_data</code> <code>Struct</code> has a one byte <code>introducer</code> field which can either be read (in hex) as <code>0x21</code> or <code>0x2c</code>. That value is then read by <code>data</code> which uses a switch to either use the <code>extension</code> type or the <code>image_descriptor</code> type respectively depending on <code>introducer</code>. The extension type then has another switch which either triggers <code>application_extension</code>, <code>comment_extension</code>, <code>graphic_control_extension</code>, or the <code>plain_text_extension</code>, all of which are separately defined <code>Structs</code>. While the <code>image_descriptor</code> <code>Struct</code> is longer, it only uses bytes or BitStructs aside from its final section, <code>data_sub_block</code>. </p>
<p>Since all of these substructs are finite, this is where the <code>GreedyRange</code> keyword comes in. <code>GreedyRange</code> is a built-in Construct parser which will repeat <code>gif_data</code> until the end of the file. Each time it's used comes with the potential for it to go down a different path of switches, adding versatility to the description.</p>
<p>Now that we have some of the basics out of the way regarding describing files in Kaitai and Construct, let's try putting it all together and create a new file format to describe some (fake) data!</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>
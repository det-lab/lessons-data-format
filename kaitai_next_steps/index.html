
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../creating_example_data/">
      
      
        <link rel="next" href="../construct_next_steps/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.2.7">
    
    
      
        <title>7. Kaitai Next Steps - Custom data format</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#objectives" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Custom data format" class="md-header__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Custom data format
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              7. Kaitai Next Steps
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Custom data format" class="md-nav__button md-logo" aria-label="Custom data format" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Custom data format
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Setup
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../filetype/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. File types
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../kaitai_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Kaitai basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../construct_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Construct basics
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../creating_example_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Creating Example Data
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    7. Kaitai Next Steps
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    7. Kaitai Next Steps
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-describing-the-data-in-kaitai" class="md-nav__link">
    7: Describing the data in Kaitai
  </a>
  
    <nav class="md-nav" aria-label="7: Describing the data in Kaitai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-parsing-raw-data-with-a-ksy-file" class="md-nav__link">
    7.1: Parsing raw data with a .ksy file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../construct_next_steps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Construct Next Steps
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. Conclusion
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Appendix
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-describing-the-data-in-kaitai" class="md-nav__link">
    7: Describing the data in Kaitai
  </a>
  
    <nav class="md-nav" aria-label="7: Describing the data in Kaitai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-parsing-raw-data-with-a-ksy-file" class="md-nav__link">
    7.1: Parsing raw data with a .ksy file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h3 id="objectives">Objectives:</h3>
<ul>
<li>Describe our fabricated data in the Kaitai IDE. </li>
<li>Use the description to parse our custom file format.</li>
</ul>
<h1 id="7-describing-the-data-in-kaitai">7: Describing the data in Kaitai</h1>
<p>Now that we have our raw binary data, we can begin working on writing the <code>.ksy</code> file which we'll be able to use later to compile our data into something useable. If you no longer have it open, navigate back to the <a href="https://ide.kaitai.io/">Kaitai web IDE</a> and create a new <code>.ksy</code> file named something like "wave_parser.ksy". We're going to start by describing the <code>meta</code> section. Our example is pretty simple, so we'll only need to fill out the <code>id</code>, <code>file-extension</code> and <code>endian</code> sections. Feel free to reference our finalized file which can also be found at <a href="https://github.com/det-lab/lessons-data-format/blob/gh-pages/examples/wave_parser.ksy">this page's github</a>.</p>
<p>Since we didn't explicitly define the endianness while creating our raw data file, it was written using your operating system's native endianness. If you are unsure what endianness your system uses, simply search "(your OS) byte order." You could also rewrite the code generating the example data to force a specific endianness. To do that, change the lines which created the arrays from:</p>
<pre><code>full_x_data = np.array(full_x, dtype=np.float32)
.
.
.
</code></pre>
<p>To instead say:</p>
<pre><code># For little-endian
full_x_data = np.array(full_x, dtype='&lt;float32') # or '&lt;f4'
.
.
.

# For big-endian
full_x_data = np.array(full_x, dtype='&gt;float32') # or '&gt;f4'
.
.
.
</code></pre>
<p>Now in our <code>meta</code> section, let's add:</p>
<pre><code>meta:
  id: test
  file-extension: test
  endian: le # or be
</code></pre>
<p>When creating our file, we used the line <code>f.write(struct.pack('I', len(full_data)))</code> to add the size of each section to the beginning of the file. In this line <code>I</code> stands for an unsigned 4-byte integer. In Kaitai, this is captured by <code>type: u4</code>, so we define a <code>type</code> called <code>full_mid_peak_lens</code> which grabs <code>full_len</code>, <code>mid_len</code>, and <code>peak_len</code> as <code>u4</code>s so that they can be used elsewhere.</p>
<pre><code>types:
  full_mid_peak_lens:
    seq:
      - id: full_len
        type: u4
      - id: mid_len
        type: u4
      - id: peak_len
        type: u4
</code></pre>
<p>Now we can go above the <code>types</code> section to the main <code>seq</code> and create an object to store these lengths so that we can retrieve them later:</p>
<pre><code>seq:
  - id: lengths
    type: full_mid_peak_lens
</code></pre>
<p>Next, we can use our newly created <code>lengths</code> object to select arrays which are the length of each respective section of the data. It's important to remember here what choice was made to define the size of your data points. As I went with <code>float32</code> for all three sections, each data point will be saved as a float valued <code>f4</code> type. Kaitai has the options of <code>f1</code>, <code>f2</code>, <code>f4</code>, and <code>f8</code> for float values, (or <code>u1</code>, <code>s1</code>, etc for unsigned or signed integers) each specifying how many bytes they capture. To capture the <code>full_data</code> section, let's move back to the <code>types</code> section and continue:</p>
<pre><code>  full_data:
    seq:
      - id: x_data
        type: f4
        repeat: expr
        repeat-expr: _root.lengths.full_len

      - id: y_data
        type: f4
        repeat: expr
        repeat-expr: _root.lengths.full_len
</code></pre>
<p>Now we can simply repeat this step for each of the sections, creating the similar <code>mid_data</code> and <code>peak_data</code> types before returning above the <code>type</code> section once more to the main <code>seq</code>. From there, all we have to do is create a new object for each of these types to be used in, which should look something like:</p>
<pre><code>  - id: f_data
    type: full_data

  - id: m_data
    type: mid_data

  - id: p_data
    type: peak_data
</code></pre>
<p>And just like that, we've described our first file format using Kaitai! Make sure to save your file, and we can learn how to use our <code>.ksy</code> file to rebuild our raw data.</p>
<h2 id="71-parsing-raw-data-with-a-ksy-file">7.1: Parsing raw data with a .ksy file</h2>
<p>It was mentioned in the page for our setup that advanced users may wish to install <code>ksc</code> for further work. Doing this install now would be necessary in order to continue, so if you have not yet followed the instructions in the <a href="/appendix/">appendix</a>, please do so to continue. </p>
<p>These instructions are also written for WSL (Windows Subsystem for Linux), but they should hold valid for other terminal installations.</p>
<p>To get started, you'll need to know the path to your .ksy file and to the folder generated by your install of <code>ksc</code>. Then, you'll want to navigate to the generated folder using WSL.</p>
<pre><code>cd /path/to/kaitai_struct_compiler
</code></pre>
<p>Next, you'll generate the source file for your target language. If you're working with languages besides python, this step might also produce a header file as well.</p>
<pre><code>ksc -t &lt;language&gt; --outdir &lt;new_foldername&gt; &lt;path/to/your/file.ksy&gt;
</code></pre>
<p>Replacing the parts in brackets accordingly. For <code>language</code>, the options are: <code>cpp_stl</code>, <code>csharp</code>, <code>java</code>, <code>javascript</code>, <code>perl</code>, <code>php</code>, <code>python</code>, <code>ruby</code>, or <code>all</code></p>
<p>For <code>new_foldername</code>, the new folder will be created inside the <code>kaitai-struct-awkward-runtime</code> folder. After running the above commands, you should have generated a new folder and file. If your target (<code>-t</code>) language was python, the generated file will appear as <code>&lt;extension&gt;.py</code>. In my case, we now have the folder <code>wave_test</code> which contains <code>test.py</code>, so we can finally put this all together.</p>
<p>You can either create a new python or notebook file at the same level as your <code>wave_test</code> folder, move/copy that folder where you want to make your parsing file, or keep the folders seperate and start your new file by running:</p>
<pre><code>import sys
</code></pre>
<p>before using <code>sys.path.append()</code> to point to the respective folder. Having the folder on the same hierarchy as your new file will avoid this extra step however. Now, we'll want to import everything from our generated file, import <code>Path</code> in order to use the raw file, and <code>matplotlib.pyplot</code> in order to plot it. If you don't have <code>Path</code> installed, first run:</p>
<pre><code>pip install Path
</code></pre>
<p>From your IDE terminal before starting your file with the lines:</p>
<pre><code>from pathlib import Path
from wave_test.test import * # replace wave_test with your folder name
import matplotlib.pyplot as plt
</code></pre>
<p>We are now able to load our data file and begin parsing it. As before, you can view my file from <a href="https://github.com/det-lab/lessons-data-format/blob/gh-pages/examples/ksy_parser.ipynb">this page's github</a>. Let's first load our raw data before parsing it as the generated <code>Test</code> class. If you didn't use the same meta level <code>id</code> as in the example, open the generated <code>.py</code> file and use the highest level <code>class</code> - or just check the <code>id</code> from your <code>meta</code> section.</p>
<pre><code>raw_data = Path('wave_data.test')
wave_data = Test.from_file(raw_data)
</code></pre>
<p>From here, the different types and their subtypes can be accessed directly as attributes, so we can print out each of the lengths using:</p>
<pre><code>f_length = wave_data.lengths.full_len
m_length = wave_data.lengths.mid_len
p_length = wave_data.lengths.peak_len
print(f_length, m_length, p_length)
&gt;&gt; 100000 78719 10020
</code></pre>
<p>We can also access the wave data in the same way:</p>
<pre><code>full_x = wave_data.f_data.x_data
full_y = wave_data.f_data.y_data
plt.plot(full_x, full_y)
</code></pre>
<p>This can be repeated for the <code>mid</code> and <code>peak</code> data as well using <code>m_data</code> and <code>p_data</code> respectively. And with that, we have officially learned how to use a <code>.ksy</code> file to read your first (extremely basic) raw data file! </p>
<p>Let's move on to doing the same with Construct definitions.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>